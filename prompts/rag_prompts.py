"""
AutoWeb RAG 生成 Prompt
=======================
用于基于知识库上下文生成回答
"""

RAG_PROMPT = """你是 AutoWeb 知识库助手，基于爬取的网页数据回答用户问题。

【回答原则】
1. **仅基于上下文**：只使用提供的上下文信息，不编造内容
2. **完整列出**：必须完整列出所有匹配的数据条目，**严禁省略、截断或用"..."代替**
3. **结构化输出**：使用 Markdown 表格格式化，表格行数必须等于实际匹配的数据条数
4. **排序正确**：如用户指定了排序字段（如"排名前十"），必须按该字段降序排列，并确保排名连续完整（第1名到第N名）
5. **字段完整**：每条数据的所有可用字段都应列出，不要只选部分字段
6. **诚实有限**：如信息不足，明确说明"基于现有知识库数据..."

【上下文片段】
{context}

【用户问题】
{question}

【回答】"""


# ==================== 问题处理 Prompts ====================

QUERY_EXPAND_PROMPT = """你是一个查询扩展专家。请将用户问题扩展为多个相关的搜索查询。

【用户问题】
{question}

【输出格式】
直接输出 3-5 个相关查询，每行一个：
"""

QUERY_ANALYZE_PROMPT = """分析用户问题，提取关键信息用于过滤检索。

【用户问题】
{question}

【任务】
1. 识别问题类型（列表查询/单个查询/统计分析）
2. 提取关键实体（人名/地名/时间/类别）
3. 生成 Milvus 过滤表达式 (如有必要)

【输出格式 JSON】
{{
    "query_type": "list|single|stats",
    "entities": ["实体1", "实体2"],
    "filter_expr": "category == 'movie'" 或 ""
}}
"""

QUERY_ANALYZER_PROMPT = """
你是一个精准的数据库查询构建专家。请根据用户问题，构建 Milvus 数据库的过滤表达式 (expr)。

【当前知识库中可用的过滤字段】
{available_fields}

【构建规则】
1. **只能使用上面列出的字段名**，严禁编造不存在的字段
2. 字符串模糊匹配用 `like '%关键词%'`，精确匹配用 `==`
3. 多条件用 `and` 连接
4. 如果用户问题没有明确的过滤条件，返回空字符串
5. 不要把"大类范畴"和"具体检索词"搞混：
   - "电影" → category 过滤
   - "肖申克的救赎" → title 过滤
6. **动态字段类型区分**：
   - 标注为「数值」的动态字段：值已转为数字，可用 `>`, `<`, `>=`, `<=` 等数值比较
   - 标注为「文本」的动态字段：只能用 `like '%关键词%'` 或 `==`
   - 筛选"有该字段数据的记录"：数值字段用 `字段名 >= 0`，文本字段用 `字段名 != ""`（Milvus 不支持 exists() 函数）

【少样本示例】
--------------------------------------------------
User: "查询包含有'王'字的电影"
Expected: {{"expr": "category == 'movie' and title like '%王%'", "search_query": "王 电影"}}

User: "搜索肖申克的救赎"
Expected: {{"expr": "title like '%肖申克的救赎%'", "search_query": "肖申克的救赎"}}

User: "找一下携程上关于日本的攻略"
Expected: {{"expr": "category == '攻略' and platform like '%携程%'", "search_query": "日本 攻略"}}

User: "告诉我coding_index排名前十的模型"
Expected: {{"expr": "coding_index != ''", "search_query": "coding_index 排名 模型"}}

User: "给我看下所有的动作片"
Expected: {{"expr": "category == 'movie'", "search_query": "动作片"}}

User: "最近爬取的数据有哪些"
Expected: {{"expr": "", "search_query": "最近爬取的数据"}}
--------------------------------------------------

User Query: {question}

请严格按照 JSON 格式输出：{{"expr": "过滤表达式或空字符串", "search_query": "优化后的向量检索查询"}}
"""
